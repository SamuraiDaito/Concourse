resources:
  - name: getappdata
    type: git
    source:
      uri: "https://github.com/SamuraiDaito/Concourse.git"
      branch: main

jobs:
  - name: fetch-secrets-and-run-script
    plan:
      - get: getappdata
        trigger: true

      - task: fetch-secrets
        config:
          platform: linux
          image_resource:
            type: docker-image
            source:
              repository: hashicorp/vault
              tag: latest
          outputs:
            - name: secrets-output
          run:
            path: sh
            args:
              - -c
              - |
                # Set Vault address and token
                export VAULT_ADDR='http://192.168.3.109:8200'
                export VAULT_TOKEN='abcd1234'
               
                # Fetch secrets from Vault
                Email=$(vault kv get -field=Email secret/screener)
                Password=$(vault kv get -field=Password secret/screener)

                # Store secrets in a file
                echo "Email=$Email" > secrets-output/secrets.env
                echo "Password=$Password" >> secrets-output/secrets.env

                # Print the secrets
                echo "Email: $Email"
                echo "Password: $Password"

      - task: login-to-screener
        config:
          platform: linux
          image_resource:
            type: docker-image
            source:
              repository: alpine
              tag: latest
          inputs:
            - name: secrets-output
          run:
            path: sh
            args:
              - -c
              - |
                # Install required packages
                apk add --no-cache curl grep
                
                # Source the secrets file
                source secrets-output/secrets.env
                
                # Fetch CSRF Token from the login page
                csrf_response=$(curl -s -c cookies.txt "https://www.screener.in/login/")
                csrf_token=$(echo "$csrf_response" | grep -oP 'name="csrfmiddlewaretoken" value="\K[^"]+')
                
                # Perform login with CSRF Token
                curl -k -X POST \
                  -b cookies.txt \
                  -c cookies.txt \
                  -H 'Content-Type: multipart/form-data; boundary=------------------------GS4aQFgnbxtLpMymaLaYIJ' \
                  -H 'Referer: https://www.screener.in/login/' \
                  -F "username=$Email" \
                  -F "password=$Password" \
                  -F "csrfmiddlewaretoken=$csrf_token" \
                  "https://www.screener.in/login/" \
                  -v
